sudo: required
os: linux
dist: xenial
language: node_js
node_js:
- lts/*
env:
  global:
  - BUILD_VERSION=0.04
  - CCACHE_SIZE=100M
  - CCACHE_TEMPDIR=/tmp/.ccache-temp
  - CCACHE_COMPRESS=1
cache:
  apt: true
  directories:
  - "$HOME/google-cloud-sdk/"
  - "$HOME/.ccache"
matrix:
  fast_finish: true
  include:
  - env: BUILD_ICONS=assets/icons/agama_icons/128x128.png IGNORE_OS_ASSETS_1=assets/bin/osx
      IGNORE_OS_ASSETS_2=assets/bin/win64 TARGET_PLATFORM=linux BUILD_DIR=build/Agama-linux-x64
      ASSETS_DIR=linux64 BUILD_VARIANT=Linux64
  - env: BUILD_ICONS=assets/icons/agama_icons/agama_app_icon.ico IGNORE_OS_ASSETS_1=assets/bin/osx
      IGNORE_OS_ASSETS_2=assets/bin/linux64 TARGET_PLATFORM=win32 BUILD_DIR=build/Agama-win32-x64
      PACKAGES=winehq-devel ASSETS_DIR=win64 BUILD_VARIANT=Win64
before_install:
- openssl aes-256-cbc -K $encrypted_a41fbd06a4b9_key -iv $encrypted_a41fbd06a4b9_iv
  -in AUTH_KEY.json.enc -out AUTH_KEY.json -d

install:
- if [ -n "$PACKAGES" ]; then sudo rm -f /etc/apt/sources.list.d/travis_ci_zeromq3-source.list;
  fi
- if [ -n "$PACKAGES" ]; then sudo dpkg --add-architecture i386 && wget -nc https://dl.winehq.org/wine-builds/Release.key;
  fi
- if [ -n "$PACKAGES" ]; then sudo apt-key add Release.key; fi
- if [ -n "$PACKAGES" ]; then sudo apt-add-repository https://dl.winehq.org/wine-builds/ubuntu/;
  fi
- if [ -n "$PACKAGES" ]; then travis_retry sudo apt-get update && sudo apt-get -y
  install --install-recommends -qq $PACKAGES; fi
- gcloud auth activate-service-account --key-file AUTH_KEY.json
- rm AUTH_KEY.json && rm AUTH_KEY.json.enc
- gsutil cp gs://$BUCKET/$ARTIFACTS/$TRAVIS_BRANCH/$BUILD_VARIANT.tar.gz .
- tar -xzvf $BUILD_VARIANT.tar.gz && rm $BUILD_VARIANT.tar.gz
- cp -rvf $BUILD_VARIANT/* assets/bin/$ASSETS_DIR
- npm install electron-packager -g &&  npm install electron -g --unsafe-perm=true
- cd gui/EasyDEX-GUI/react && gsutil cp gs://$BUCKET/EasyDEX-GUI/$TRAVIS_BRANCH/build.tar.gz . || gsutil cp gs://$BUCKET/EasyDEX-GUI/master/build.tar.gz .
- tar -xzvf build.tar.gz && rm build.tar.gz
- cd ../../.. && npm install webpack
- npm install
script:
- electron-packager . --platform=$TARGET_PLATFORM --arch=x64 --icon=$BUILD_ICONS --out=build/
  --buildVersion=$BUILD_VERSION --ignore=$IGNORE_OS_ASSETS_1 --ignore=$IGNORE_OS_ASSETS_2
  --overwrite
after_script:
if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then gsutil cp $BUILD_DIR.tar.gz gs://$BUCKET/$PROJECT/$TRAVIS_BRANCH/; fi
notifications:
  slack:
    secure: Fk0YtlRYTZVYOri1yR1F2WwPmqDMIgLm7VhlI6+3X0eNzj4fEzcAgE0hBulsep5S4wAMpk4Cdk3ryVhMkeXuUq2fVtERZGlyDSp3m5HQjOcg51GtiJrZ0Udh1yebj13T8Kpg9ro2cXh+dPKy9Nyqjqk+faZnP8JyapD/R1NYUA1zhQw+uC0rbLEr43GQi3wkVYmVZqbmIR2MfZGTqAJK+6lUraFJfSJXOqPGhEyM+L4W1uBMkd7+IeV4gquqcd00V8Vj20y98M27H7DM87sdYkg5Nunr6V2MpT4IVVd8bFIVdQf8jWtCK2n0B3w8U7Z+Elwx4aUQFFystxdfXF7Kr4m+yyXI0UqO4N2+OsKSfQfOptw5JGKtpYmrUz/Psuu6i6RSWpp+YSXbhAGfLuy8m8HKyurSgDxr/gGZ+A2hQLQ8g7hsiHtNayS6iae383Ao9HqAMKeGgpn5VDqBAqSpuhnOW7mQfa6SmbpcPrL9jBXk6NF6fWL9Wi5S/w9cqMzLO/7rA7V0HtdSMVFFNr0Q94e3/G3yE34/25oQC7FRmrXr/su3vddwnVEDhhnohUK8nxK0iKie0nEDgMHEORvA0i3nk0PSb1t3VK7SRFgbL0H6qziyu/A5JOtqRmKjHOhGiHOjwHkXYdPTEF8WUnk630rMPSITxRbHOv7NYXz/4gM=
